# Django web-based visualization

This directory contains a Django project powering a visualization of the SBA loan data.

## Apps

The code is split into 2 apps:
- `api_server` contains the models interfacing with the PostgreSQL server, and exposes data with a JSON API
- `web_app` contains some static HTML/CSS/JS running a rich client webapp that consumes the API and renders the visualization

## Web app directory and build structure

Here's a little more info about the frontend build and toolchain, in case anyone is new to it.

### Build tools

We use Yarn to run Webpack, which transforms and bundles the source JS files from `static_src` and puts them in the `static` directory.  Webpack uses a number of plugins to transform the JS; one of these plugins is Babel, which is configured to convert JSX syntax into JS, and convert ES2015 features down to ES5 which all browsers can handle.  You can see the Yarn configuration in `package.json`, the Webpack configuration in `webpack.config.js`, and the Babel configuration in `.babelrc` (all in the `web_app` directory).

### Directories

- `templates` contains the HTML templates; note they're grouped into a `web_app` subdirectory to avoid confusion in Django's template lookup
- `static_src` contains any source JS/CSS image files that will be processed and bundled by Webpack/Babel.  If you want to make changes to the frontend, this is the place to do it.
- `static` contains the static JS/CSS/image files that will be served by the webserver.  Webpack puts its output bundles here.  Note you should NOT make any manual changes to the files in this directory, as they are auto-generated by the build process and are in `.gitignore` anyway.

### Yarn Scripts

You can use Yarn to run the following scripts:
1. `yarn run build`: builds the JS bundles for local development
1. `yarn run build-production`: builds the JS bundles for production deployment (eg may include minimization)
1. `yarn run build:watch`: builds the JS bundles for local development, and then continues to watch the JS source files so any changes to them are automatically rebuilt into the JS bundles
1. `yarn run test`: runs the JS unit tests
1. `yarn run test:watch`: runs the JS unit tests and continues to watch the JS files so the tests are re-run whenever the files change

Also, look at `web_app/package.json` to see exactly what these scripts are doing

## Running the webapp locally

For anyone wanting to run the whole app locally, you can do the following.


Run the following commands once, to get everything set up:

1. Set up a local DB and populate it with data (either by dumping the prod DB or by running the pipeline locally, as described [here](../../pipeline/README.md))
1. Set the environment variable for your database URL, e.g. `export SBA_DWH='postgresql://username:password@127.0.0.1:5432/postgres'`
1. Install [Yarn](https://yarnpkg.com/lang/en/docs/install/)
1. From within the `web_app` directory, run `yarn install` to load all the required packages listed in `package.json`
1. From within the `web_app` directory, run `yarn run build` to build the JS bundles for the first time

Then run the following whenever you want to run the app:

1. Run `python manage.py runserver` from within the `django_tutorial/first_project` directory -- this starts the webserver
1. (optional) Run `yarn run build:watch` from within the `web_app` directory -- this watches your JS source files so that any changes you make in them are immediately reflected in the app, without having to run `yarn run build` each time
1. Go to `http://127.0.0.1:8000/app/` in your browser.

The `python manage.py runserver` command should give output like this:
```
$ python manage.py runserver
Performing system checks...

System check identified no issues (0 silenced).
August 22, 2017 - 02:19:49
Django version 1.11.3, using settings 'first_project.settings'
Starting development server at http://127.0.0.1:8000/
```

And the `yarn run build:watch` command should give output like this:
```
$ yarn run build:watch
yarn run v1.0.2
$ webpack --config webpack.config.js --progress --colors --watch
 10% building modules 1/1 modules 0 active                                         
Webpack is watching the filesâ€¦

Hash: 0bde532659be05ac4f46                                                              
Version: webpack 3.5.6
Time: 30300ms
                    Asset     Size  Chunks                    Chunk Names
       js/index.bundle.js  6.74 MB       0  [emitted]  [big]  index
            css/style.css  1.12 kB          [emitted]         
    tempdata/ca_zips.json   574 kB          [emitted]  [big]  
tempdata/ca_zips_geo.json  2.96 MB          [emitted]  [big]  
  [31] ./static_src/js/redux/feature.js 10.4 kB {0} [built]
  [55] ./static_src/js/redux/root.js 3.06 kB {0} [built]
  [56] ./static_src/js/utilities.js 4.35 kB {0} [built]
 [135] ./static_src/js/redux/color.js 2.93 kB {0} [built]
 [136] ./static_src/js/redux/filter.js 3.59 kB {0} [built]
 [200] (webpack)/buildin/global.js 823 bytes {0} [built]
 [346] multi ./static_src/js/index 28 bytes {0} [built]
 [347] ./static_src/js/index.js 1.45 kB {0} [built]
 [474] ./static_src/js/api.js 931 bytes {0} [built]
 [477] ./static_src/js/views/containers/App.js 1.69 kB {0} [built]
 [478] ./static_src/js/views/containers/ColorControls.js 2.54 kB {0} [built]
 [769] ./static_src/js/views/containers/FilterControls.js 2.31 kB {0} [built]
 [863] ./static_src/js/views/containers/GoogleMap.js 10 kB {0} [built]
 [865] ./static_src/js/views/containers/MapTooltip.js 2.68 kB {0} [built]
 [866] ./static_src/js/views/containers/FeatureTypeSelector.js 2.1 kB {0} [built]
    + 852 hidden modules
```

## Hosting

We're currently hosting the MVP on a free-tier AWS server.  See the slack channel for the URL, and ping someone if you want credentials to access the server.

The server just has a clone of the git repo in ~/datasci-sba.  To deploy a new version, you can cd into it, fetch whatever branch you want (currently september-mvp) and then run the following to start the server:
```
cd ~/datasci-sba/django_tutorial/first_project
sudo pkill -f python3
npm --prefix web_app run build
export SBA_DWH='FILL IN DB CREDS HERE'
nohup sudo -E bash -c 'python3 manage.py runserver 0.0.0.0:80' &
```

This is a pretty hackish solution, and there are a number of things we'll want to do after the MVP:
1. Switch to Azure (or maybe a more managed hosting solution, like Heroku?)
1. We really shouldn't be running Django as root on port 80, but instead use Apache/WSGI as a webserver.
1. Ideally we'd run 'build-production' instead of 'build' for the JS build, but the former causes our free-tier AWS instance to run out of memory!
1. Integrate with a real deployment process (eg CircleCI)

## Tests

### Web App Unit Tests

We use Jest to run JS unit tests.  Test files are in `static_src` co-located with the files they're testing -- for instance next to `redux/color.js` there is `redux/color.test.js`.  You can run the tests with `yarn run test` from the `web_app` directory, or `yarn run test:watch` to run the tests and watch the JS files so the tests are re-run whenever the files change.

### Web App End-to-End Tests

None yet; we should work on getting Selenium or someting similar set up for this.

### API Server Tests

None yet, should be added once we set up Django REST framework.
