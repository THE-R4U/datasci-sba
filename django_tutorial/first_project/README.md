# Django web-based visualization

This directory contains a Django project powering a visualization of the SBA loan data.

## Apps

The code is split into 2 apps:
- `api_server` contains the models interfacing with the PostgreSQL server, and exposes data with a JSON API
- `web_app` contains some static HTML/CSS/JS running a rich client webapp that consumes the API and renders the visualization

## Web app directory and build structure

Here's a little more info about the frontend build and toolchain, in case anyone is new to it.

### Build tools

We use NPM to run Webpack, which transforms and bundles the source JS files from `static_src` and puts them in the `static` directory.  Webpack uses a number of plugins to transform the JS; one of these plugins is Babel, which is configured to convert JSX syntax into JS, and convert ES2015 features down to ES5 which all browsers can handle.  You can see the NPM configuration in `package.json`, the Webpack configuration in `webpack.config.js`, and the Babel configuration in `.babelrc` (all in the `web_app` directory).

### Directories

- `templates` contains the HTML templates; note they're grouped into a `web_app` subdirectory to avoid confusion in Django's template lookup
- `static_src` contains any source JS/CSS image files that will be processed and bundled by Webpack/Babel.  If you want to make changes to the frontend, this is the place to do it.
- `static` contains the static JS/CSS/image files that will be served by the webserver.  Webpack puts its output bundles here.  Note you should NOT make any manual changes to the files in this directory, as they are auto-generated by the build process and are in `.gitignore` anyway.

### NPM Scripts

You can use NPM to run the following scripts:
1. `npm run build`: builds the JS bundles for local development
1. `npm run build-production`: builds the JS bundles for production deployment (eg may include minimization)
1. `npm run watch`: builds the JS bundles for local development, and then continues to watch the JS source files so any changes to them are automatically rebuilt into the JS bundles

Also, look at `web_app/package.json` to see exactly what these scripts are doing

## Running it

For anyone wanting to run the whole app locally, you can do the following.


Run the following commands once, to get everything set up:

1. Set up a local DB and populate it with data (either by dumping the prod DB or by running the pipeline locally, as described [here](../../pipeline/README.md))
1. Set the environment variable for your database URL, e.g. `export SBA_DWH='postgresql://username:password@127.0.0.1:5432/postgres'`
1. Install [Node and NPM](https://www.npmjs.com/get-npm)
1. From within the `web_app` directory, run `npm install` to load all the required NPM packages
1. From within the `web_app` directory, run `npm run build` to build the JS bundles for the first time

Then run the following whenever you want to run the app:

1. Run `python manage.py runserver` from within this directory -- this starts the webserver
1. (optional) Run `npm run watch` from within the `web_app` directory -- this watches your JS source files so that any changes you make in them are immediately reflected in the app, without having to run `npm run build` each time
1. Go to `http://127.0.0.1:8000/app/` in your browser.

The `python manage.py runserver` command should give output like this:
```
$ python manage.py runserver
Performing system checks...

System check identified no issues (0 silenced).
August 22, 2017 - 02:19:49
Django version 1.11.3, using settings 'first_project.settings'
Starting development server at http://127.0.0.1:8000/
```

And the `npm run watch` command should give output like this:
```
$ npm run watch

> sba_web_app@0.1.0 watch /home/adamd/workspace/sba/django_tutorial/first_project/web_app
> webpack --config webpack.config.js --progress --colors --watch

 10% building modules 1/1 modules 0 active                                         
Webpack is watching the filesâ€¦

Hash: 523bd7630819724160cb                                                              
Version: webpack 3.5.5
Time: 9715ms
          Asset     Size  Chunks                    Chunk Names
index.bundle.js  3.98 MB       0  [emitted]  [big]  index
  [37] ./static_src/js/utilities.js 4.34 kB {0} [built]
  [46] ./static_src/js/redux/regions.js 5.44 kB {0} [built]
  [87] ./static_src/js/redux/color.js 2.01 kB {0} [built]
  [88] ./static_src/js/redux/filter.js 2.79 kB {0} [built]
 [109] (webpack)/buildin/global.js 823 bytes {0} [built]
 [165] (webpack)/buildin/amd-options.js 82 bytes {0} [built]
 [173] multi ./static_src/js/index 28 bytes {0} [built]
 [174] ./static_src/js/index.js 2.49 kB {0} [built]
 [185] (webpack)/buildin/module.js 521 bytes {0} [built]
 [303] ./static_src/js/views/containers/App.js 1.28 kB {0} [built]
 [304] ./static_src/js/views/containers/ColorControls.js 993 bytes {0} [built]
 [305] ./static_src/js/views/containers/FilterControls.js 1.61 kB {0} [built]
 [401] ./static_src/js/views/containers/GoogleMap.js 7.43 kB {0} [built]
 [402] ./static_src/js/views/containers/MapTooltip.js 1.89 kB {0} [built]
    + 389 hidden modules
```


